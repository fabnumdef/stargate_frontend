stages:
  - build
  - test
  - deploy

include:
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /proxy/licence-scanning.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /proxy/dependency-scanning.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /proxy/container-scanning.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /proxy/secret-scanning.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /proxy/sast.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /npm.auto.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /docker.auto.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /helm.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /helm.reviews.auto.yml
  - project: fabnum-minarm/igloo/gitlab-templates
    file: /helm.staging.auto.yml

variables:
  HELM_CHART: igloo-stable/nodejs
  HELM_ENV_VAR_VERSION: Version ${CI_COMMIT_REF_NAME} - ${CI_COMMIT_SHA} (job \#${CI_JOB_ID})

deploy:staging:
  variables:
    HOST: ${BASE_DOMAIN}
    HELM_INGRESS_HOST: $HOST
    HELM_ENV_VAR_API_URL: https://api.${BASE_DOMAIN}/api
    HELM_NAME: frontend
  environment:
    url: https://${BASE_DOMAIN}

deploy:staging:uninstall:
  variables:
    HELM_NAME: frontend

deploy:review:
  variables:
    HOST: ${CI_ENVIRONMENT_SLUG}.${BASE_DOMAIN}
    HELM_INGRESS_HOST: $HOST
    HELM_NAME: frontend-${CI_COMMIT_REF_SLUG}
    HELM_ENV_VAR_API_URL: https://api.${BASE_DOMAIN}/api
  environment:
    url: https://${CI_ENVIRONMENT_SLUG}.${BASE_DOMAIN}

deploy:review:uninstall:
  variables:
    HELM_NAME: frontend-${CI_COMMIT_REF_SLUG}
